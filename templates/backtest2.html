{% extends "layout.html" %}

{% block content %}
<style>
    .strategy-box {
        border: 2px solid #2196F3;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        background: #f8f9fa;
    }
    .indicator-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin: 8px 0;
    }
    .add-btn {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .remove-btn {
        background: #f44336;
        color: white;
        border: none;
        padding: 4px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }
</style>

<h1>å›æ¸¬ç³»çµ± v2 (ç­–ç•¥=æŒ‡æ¨™çµ„åˆ)</h1>

<div style="margin: 20px 0;">
    <label>æ—ç¾¤: </label>
    <select id="level1Select" onchange="loadLevel2()" style="padding: 5px;">
        <option value="å…¨éƒ¨">å…¨éƒ¨</option>
    </select>
    <select id="level2Select" onchange="loadStocksBySector()" style="padding: 5px; margin-left: 10px;">
        <option value="">å…¨éƒ¨</option>
    </select>
    <label style="margin-left: 20px;">è‚¡ç¥¨ä»£ç¢¼: </label>
    <select id="stockSelect" style="padding: 5px;">
        <option value="2330">2330 å°ç©é›»</option>
    </select>
    <label style="margin-left: 20px;">åˆå§‹è³‡é‡‘: </label>
    <input type="number" id="initialCapital" value="1000000" style="width: 120px;">
</div>

<div style="display: flex; gap: 30px;">
    <div style="flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3>è²·é€²ç­–ç•¥ (ä»»ä¸€ç­–ç•¥é”æ¨™å³è²·é€²)</h3>
            <div style="display: flex; gap: 5px;">
                <button onclick="saveBuyStrategy()" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ’¾</button>
                <select id="savedBuyStrategies" onchange="loadSavedBuyStrategy()" style="padding: 5px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- è¼‰å…¥ --</option>
                </select>
                <button onclick="deleteBuyStrategy()" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
            </div>
        </div>
        <button class="add-btn" onclick="addBuyStrategy()">â• æ–°å¢è²·é€²ç­–ç•¥</button>
        <div id="buyStrategies"></div>
    </div>
    
    <div style="flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3>è³£å‡ºç­–ç•¥ (ä»»ä¸€ç­–ç•¥é”æ¨™å³è³£å‡º)</h3>
            <div style="display: flex; gap: 5px;">
                <button onclick="saveSellStrategy()" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ’¾</button>
                <select id="savedSellStrategies" onchange="loadSavedSellStrategy()" style="padding: 5px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- è¼‰å…¥ --</option>
                </select>
                <button onclick="deleteSellStrategy()" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
            </div>
        </div>
        <button class="add-btn" onclick="addSellStrategy()">â• æ–°å¢è³£å‡ºç­–ç•¥</button>
        <div id="sellStrategies"></div>
    </div>
</div>

<div style="margin: 20px 0;">
    <button onclick="runBacktest()" style="padding: 10px 30px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">åŸ·è¡Œå›æ¸¬</button>
</div>

<div id="results" style="display: none;"></div>
<div id="chart" style="width: 100%; height: 750px; margin-top: 20px;"></div>

<script>
let buyStrategies = [];
let sellStrategies = [];
let buyStrategyCounter = 0;
let sellStrategyCounter = 0;

function confirmBuyStrategy(id) {
    const strategy = buyStrategies.find(s => s.id === id);
    if (strategy && strategy.indicators.length > 0) {
        strategy.confirmed = true;
        renderBuyStrategies();
    } else {
        alert('ç­–ç•¥è‡³å°‘éœ€è¦ä¸€å€‹æŒ‡æ¨™');
    }
}

function confirmSellStrategy(id) {
    const strategy = sellStrategies.find(s => s.id === id);
    if (strategy && strategy.indicators.length > 0) {
        strategy.confirmed = true;
        renderSellStrategies();
    } else {
        alert('ç­–ç•¥è‡³å°‘éœ€è¦ä¸€å€‹æŒ‡æ¨™');
    }
}

function editBuyStrategy(id) {
    const strategy = buyStrategies.find(s => s.id === id);
    if (strategy) {
        strategy.confirmed = false;
        renderBuyStrategies();
    }
}

function editSellStrategy(id) {
    const strategy = sellStrategies.find(s => s.id === id);
    if (strategy) {
        strategy.confirmed = false;
        renderSellStrategies();
    }
}

const indicatorConfigs = {
    ma_crossover: { name: 'MAå‡ç·šäº¤å‰', category: 'æŠ€è¡“é¡', params: { short_window: 5, long_window: 20 } },
    rsi: { name: 'RSIæŒ‡æ¨™', category: 'æŠ€è¡“é¡', params: { period: 14, buy_threshold: 30, sell_threshold: 70 } },
    high_volume: { name: 'çˆ†é‡', category: 'æŠ€è¡“é¡', params: { volume_multiplier: 2.0 } },
    ma_slope_up: { name: 'MAå‘ä¸Š', category: 'æŠ€è¡“é¡', params: { window: 20, threshold: 10, hold_days: 3 } },
    ma_slope_down: { name: 'MAå‘ä¸‹', category: 'æŠ€è¡“é¡', params: { window: 20, threshold: -10, hold_days: 3 } },
    take_profit: { name: 'åœåˆ©', category: 'é¢¨æ§é¡', params: { profit_pct: 10 } },
    stop_loss: { name: 'åœæ', category: 'é¢¨æ§é¡', params: { loss_pct: -5 } },
    foreign_consecutive_buy: { name: 'å¤–è³‡é€£çºŒè²·è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    trust_consecutive_buy: { name: 'æŠ•ä¿¡é€£çºŒè²·è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    dealer_consecutive_buy: { name: 'è‡ªç‡Ÿå•†é€£çºŒè²·è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    foreign_consecutive_sell: { name: 'å¤–è³‡é€£çºŒè³£è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    trust_consecutive_sell: { name: 'æŠ•ä¿¡é€£çºŒè³£è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    foreign_holding_high: { name: 'å¤–è³‡æŒè‚¡æ¯”é«˜', category: 'ç±Œç¢¼é¡', params: { threshold: 30 } },
    foreign_holding_low: { name: 'å¤–è³‡æŒè‚¡æ¯”ä½', category: 'ç±Œç¢¼é¡', params: { threshold: 10 } }
};

function addBuyStrategy() {
    const id = ++buyStrategyCounter;
    buyStrategies.push({ id, indicators: [], confirmed: false });
    renderBuyStrategies();
}

function addSellStrategy() {
    const id = ++sellStrategyCounter;
    sellStrategies.push({ id, indicators: [], confirmed: false });
    renderSellStrategies();
}

function removeBuyStrategy(id) {
    buyStrategies = buyStrategies.filter(s => s.id !== id);
    renderBuyStrategies();
}

function removeSellStrategy(id) {
    sellStrategies = sellStrategies.filter(s => s.id !== id);
    renderSellStrategies();
}

function addIndicatorToBuy(strategyId) {
    const strategy = buyStrategies.find(s => s.id === strategyId);
    if (strategy) {
        strategy.indicators.push({ type: 'ma_crossover', params: {...indicatorConfigs.ma_crossover.params} });
        renderBuyStrategies();
    }
}

function addIndicatorToSell(strategyId) {
    const strategy = sellStrategies.find(s => s.id === strategyId);
    if (strategy) {
        strategy.indicators.push({ type: 'ma_crossover', params: {...indicatorConfigs.ma_crossover.params} });
        renderSellStrategies();
    }
}

function removeIndicatorFromBuy(strategyId, indicatorIdx) {
    const strategy = buyStrategies.find(s => s.id === strategyId);
    if (strategy) {
        strategy.indicators.splice(indicatorIdx, 1);
        renderBuyStrategies();
    }
}

function removeIndicatorFromSell(strategyId, indicatorIdx) {
    const strategy = sellStrategies.find(s => s.id === strategyId);
    if (strategy) {
        strategy.indicators.splice(indicatorIdx, 1);
        renderSellStrategies();
    }
}

function changeIndicatorType(strategyId, indicatorIdx, isBuy) {
    const strategies = isBuy ? buyStrategies : sellStrategies;
    const strategy = strategies.find(s => s.id === strategyId);
    if (strategy && strategy.indicators[indicatorIdx]) {
        const select = event.target;
        const newType = select.value;
        strategy.indicators[indicatorIdx] = { 
            type: newType, 
            params: {...indicatorConfigs[newType].params} 
        };
        isBuy ? renderBuyStrategies() : renderSellStrategies();
    }
}

function updateParam(strategyId, indicatorIdx, paramName, isBuy) {
    const strategies = isBuy ? buyStrategies : sellStrategies;
    const strategy = strategies.find(s => s.id === strategyId);
    if (strategy && strategy.indicators[indicatorIdx]) {
        strategy.indicators[indicatorIdx].params[paramName] = parseFloat(event.target.value);
    }
}

function renderBuyStrategies() {
    const container = document.getElementById('buyStrategies');
    container.innerHTML = buyStrategies.map(strategy => {
        if (strategy.confirmed) {
            return `
                <div class="strategy-box" style="background: #e8f5e9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>âœ“ ç­–ç•¥ ${strategy.id} (${strategy.indicators.length} å€‹æŒ‡æ¨™)</strong>
                        <div>
                            <button class="add-btn" onclick="editBuyStrategy(${strategy.id})" style="background: #2196F3; margin-right: 5px;">ç·¨è¼¯</button>
                            <button class="remove-btn" onclick="removeBuyStrategy(${strategy.id})">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `;
        }
        return `
            <div class="strategy-box">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>ç­–ç•¥ ${strategy.id} (æ‰€æœ‰æŒ‡æ¨™éƒ½é”æ¨™æ‰è²·é€²)</strong>
                    <button class="remove-btn" onclick="removeBuyStrategy(${strategy.id})">åˆªé™¤ç­–ç•¥</button>
                </div>
                ${strategy.indicators.map((ind, idx) => `
                    <div class="indicator-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <select onchange="changeIndicatorType(${strategy.id}, ${idx}, true)">
                                ${Object.entries(indicatorConfigs).reduce((acc, [key, config]) => {
                                    if (!acc.categories.includes(config.category)) {
                                        acc.categories.push(config.category);
                                        acc.html += `<optgroup label="${config.category}">`;
                                    }
                                    acc.html += `<option value="${key}" ${ind.type === key ? 'selected' : ''}>${config.name}</option>`;
                                    return acc;
                                }, { categories: [], html: '' }).html + '</optgroup>'}
                            </select>
                            <button class="remove-btn" onclick="removeIndicatorFromBuy(${strategy.id}, ${idx})">âœ•</button>
                        </div>
                        <div style="margin-top: 8px;">
                            ${Object.keys(ind.params).map(param => `
                                <label style="margin-right: 10px; font-size: 13px;">
                                    ${param}: <input type="number" step="1" value="${ind.params[param]}" 
                                        onchange="updateParam(${strategy.id}, ${idx}, '${param}', true)" 
                                        style="width: 70px;">
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button class="add-btn" onclick="addIndicatorToBuy(${strategy.id})" style="font-size: 12px; padding: 5px 10px;">â• æ–°å¢æŒ‡æ¨™</button>
                    <button class="add-btn" onclick="confirmBuyStrategy(${strategy.id})" style="background: #ff9800; font-size: 12px; padding: 5px 10px;">âœ“ å®Œæˆ</button>
                </div>
            </div>
        `;
    }).join('');
}

function renderSellStrategies() {
    const container = document.getElementById('sellStrategies');
    container.innerHTML = sellStrategies.map(strategy => {
        if (strategy.confirmed) {
            return `
                <div class="strategy-box" style="background: #e8f5e9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>âœ“ ç­–ç•¥ ${strategy.id} (${strategy.indicators.length} å€‹æŒ‡æ¨™)</strong>
                        <div>
                            <button class="add-btn" onclick="editSellStrategy(${strategy.id})" style="background: #2196F3; margin-right: 5px;">ç·¨è¼¯</button>
                            <button class="remove-btn" onclick="removeSellStrategy(${strategy.id})">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `;
        }
        return `
            <div class="strategy-box">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>ç­–ç•¥ ${strategy.id} (æ‰€æœ‰æŒ‡æ¨™éƒ½é”æ¨™æ‰è³£å‡º)</strong>
                    <button class="remove-btn" onclick="removeSellStrategy(${strategy.id})">åˆªé™¤ç­–ç•¥</button>
                </div>
                ${strategy.indicators.map((ind, idx) => `
                    <div class="indicator-item">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <select onchange="changeIndicatorType(${strategy.id}, ${idx}, false)">
                                ${Object.entries(indicatorConfigs).reduce((acc, [key, config]) => {
                                    if (!acc.categories.includes(config.category)) {
                                        acc.categories.push(config.category);
                                        acc.html += `<optgroup label="${config.category}">`;
                                    }
                                    acc.html += `<option value="${key}" ${ind.type === key ? 'selected' : ''}>${config.name}</option>`;
                                    return acc;
                                }, { categories: [], html: '' }).html + '</optgroup>'}
                            </select>
                            <button class="remove-btn" onclick="removeIndicatorFromSell(${strategy.id}, ${idx})">âœ•</button>
                        </div>
                        <div style="margin-top: 8px;">
                            ${Object.keys(ind.params).map(param => `
                                <label style="margin-right: 10px; font-size: 13px;">
                                    ${param}: <input type="number" step="1" value="${ind.params[param]}" 
                                        onchange="updateParam(${strategy.id}, ${idx}, '${param}', false)" 
                                        style="width: 70px;">
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button class="add-btn" onclick="addIndicatorToSell(${strategy.id})" style="font-size: 12px; padding: 5px 10px;">â• æ–°å¢æŒ‡æ¨™</button>
                    <button class="add-btn" onclick="confirmSellStrategy(${strategy.id})" style="background: #ff9800; font-size: 12px; padding: 5px 10px;">âœ“ å®Œæˆ</button>
                </div>
            </div>
        `;
    }).join('');
}

let currentData = null;
let allBacktestResults = [];

function runBacktest() {
    if (buyStrategies.length === 0 || sellStrategies.length === 0) {
        alert('è«‹è‡³å°‘æ–°å¢ä¸€å€‹è²·é€²ç­–ç•¥å’Œä¸€å€‹è³£å‡ºç­–ç•¥');
        return;
    }
    
    const hasEmptyBuy = buyStrategies.some(s => s.indicators.length === 0);
    const hasEmptySell = sellStrategies.some(s => s.indicators.length === 0);
    if (hasEmptyBuy || hasEmptySell) {
        alert('æ¯å€‹ç­–ç•¥è‡³å°‘éœ€è¦ä¸€å€‹æŒ‡æ¨™');
        return;
    }
    
    const hasUnconfirmedBuy = buyStrategies.some(s => !s.confirmed);
    const hasUnconfirmedSell = sellStrategies.some(s => !s.confirmed);
    if (hasUnconfirmedBuy || hasUnconfirmedSell) {
        alert('è«‹å…ˆå®Œæˆæ‰€æœ‰ç­–ç•¥çš„è¨­å®š');
        return;
    }
    
    const code = document.getElementById('stockSelect').value;
    const initialCapital = document.getElementById('initialCapital').value;
    
    const buyData = buyStrategies.map(s => ({ indicators: s.indicators }));
    const sellData = sellStrategies.map(s => ({ indicators: s.indicators }));
    
    fetch(`/api/backtest/${code}?buy_strategies=${encodeURIComponent(JSON.stringify(buyData))}&sell_strategies=${encodeURIComponent(JSON.stringify(sellData))}&initial_capital=${initialCapital}`)
        .then(res => res.json())
        .then(result => {
            if (result.error) {
                alert('å›æ¸¬å¤±æ•—: ' + result.error);
                return;
            }
            allBacktestResults = [result];
            displayResults([result]);
            loadChartData(code);
        })
        .catch(err => {
            alert('å›æ¸¬å¤±æ•—: ' + err.message);
        });
}

function loadChartData(code) {
    fetch(`/api/data/${code}`)
        .then(res => res.json())
        .then(data => {
            currentData = data;
            drawChart(data, allBacktestResults);
        });
}

function displayResults(results) {
    const resultsDiv = document.getElementById('results');
    resultsDiv.style.display = 'block';
    
    let html = '<h2>å›æ¸¬çµæœ</h2>';
    
    results.forEach((result, idx) => {
        const profit = result.profit;
        const returnRate = result.return_rate;
        
        html += `
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin: 20px 0;">
                <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                    <span>åˆå§‹è³‡é‡‘: <strong>${result.initial_capital.toLocaleString()}</strong></span>
                    <span>æœ€çµ‚åƒ¹å€¼: <strong>${result.final_value.toLocaleString()}</strong></span>
                    <span>ç²åˆ©: <strong style="color: ${profit >= 0 ? '#f44336' : '#4caf50'};">${profit.toLocaleString()}</strong></span>
                    <span>å ±é…¬ç‡: <strong style="color: ${returnRate >= 0 ? '#f44336' : '#4caf50'};">${returnRate.toFixed(2)}%</strong></span>
                    <span>äº¤æ˜“æ¬¡æ•¸: <strong>${result.total_trades}</strong></span>
                    <span>å‹ç‡: <strong style="color: ${result.win_rate >= 50 ? '#4caf50' : '#f44336'};">${result.win_rate.toFixed(2)}%</strong></span>
                    <button id="toggleDetail${idx}" onclick="toggleTradeDetails(${idx})" style="padding: 5px 15px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ“Š æŸ¥çœ‹äº¤æ˜“æ˜ç´°</button>
                </div>
                <div id="tradeDetail${idx}" style="display: none;"></div>
            </div>
        `;
    });
    
    resultsDiv.innerHTML = html;
}

function toggleTradeDetails(resultIdx) {
    const detailDiv = document.getElementById(`tradeDetail${resultIdx}`);
    const btn = document.getElementById(`toggleDetail${resultIdx}`);
    
    if (detailDiv.style.display === 'none') {
        const result = allBacktestResults[resultIdx];
        const sellTrades = result.trades.filter(t => t.é¡å‹ === 'è³£å‡º');
        
        let html = '<h3 style="margin-top: 15px;">äº¤æ˜“æ˜ç´°</h3><table style="width:100%; border-collapse: collapse; margin-top: 10px; font-size: 11px;"><thead><tr style="background: #f5f5f5;"><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">#</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">è²·å…¥æ—¥æœŸ</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">è²·å…¥ç­–ç•¥</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">è²·å…¥åƒ¹</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">è³£å‡ºæ—¥æœŸ</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">è³£å‡ºç­–ç•¥</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">è³£å‡ºåƒ¹</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">æ•¸é‡</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">ç²åˆ©</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">å ±é…¬ç‡</th><th style="padding: 6px; text-align: center; border: 1px solid #ddd;">è³£å‡ºåŸå› </th></tr></thead><tbody>';
        
        sellTrades.forEach(trade => {
            const buyRecords = trade.è²·å…¥è¨˜éŒ„ || [];
            const buyDates = buyRecords.map(r => r.æ—¥æœŸ).join(', ');
            const avgBuyPrice = buyRecords.length > 0 ? (buyRecords.reduce((sum, r) => sum + r.åƒ¹æ ¼ * r.æ•¸é‡, 0) / trade.æ•¸é‡).toFixed(2) : 0;
            const profitClass = trade.ç²åˆ© >= 0 ? '#f44336' : '#4caf50';
            
            const buyStrategy = result.trades.find(t => t.é¡å‹ === 'è²·å…¥' && buyRecords.some(r => r.æ—¥æœŸ === t.æ—¥æœŸ));
            const buyStrategyNum = buyStrategy && buyStrategy.ç­–ç•¥ç·¨è™Ÿ ? buyStrategy.ç­–ç•¥ç·¨è™Ÿ.join(',') : '-';
            const sellStrategyNum = trade.ç­–ç•¥ç·¨è™Ÿ ? trade.ç­–ç•¥ç·¨è™Ÿ.join(',') : '-';
            const tradeNum = buyStrategy && buyStrategy.äº¤æ˜“ç·¨è™Ÿ ? buyStrategy.äº¤æ˜“ç·¨è™Ÿ : '-';
            
            html += `<tr>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px; font-weight: bold;">${tradeNum}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${buyDates}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${buyStrategyNum}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${avgBuyPrice}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${trade.æ—¥æœŸ}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${sellStrategyNum}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${trade.åƒ¹æ ¼.toFixed(2)}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${trade.æ•¸é‡.toLocaleString()}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px; font-weight: bold; color: ${profitClass};">${trade.ç²åˆ©.toLocaleString()}</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px; font-weight: bold; color: ${profitClass};">${trade.å ±é…¬ç‡.toFixed(2)}%</td>
                <td style="padding: 6px; text-align: center; border: 1px solid #ddd; font-size: 11px;">${trade.è³£å‡ºåŸå›  || '-'}</td>
            </tr>`;
        });
        
        html += '</tbody></table>';
        detailDiv.innerHTML = html;
        detailDiv.style.display = 'block';
        btn.textContent = 'âœ– æ”¶èµ·æ˜ç´°';
    } else {
        detailDiv.style.display = 'none';
        btn.textContent = 'ğŸ“Š æŸ¥çœ‹äº¤æ˜“æ˜ç´°';
    }
}

function drawChart(data, results) {
    const chart = echarts.init(document.getElementById('chart'));
    const dates = data.map(d => d.æ—¥æœŸ);
    const klineData = data.map(d => [d.é–‹ç›¤åƒ¹, d.æ”¶ç›¤åƒ¹, d.æœ€ä½åƒ¹, d.æœ€é«˜åƒ¹]);
    const volumeData = data.map(d => d.æˆäº¤é‡);
    
    const ma5Data = data.map(d => d.MA5 || null);
    const ma10Data = data.map(d => d.MA10 || null);
    const ma20Data = data.map(d => d.MA20 || null);
    
    const series = [
        {
            name: 'Kç·š',
            type: 'candlestick',
            data: klineData,
            itemStyle: {
                color: '#ef5350',
                color0: '#26a69a',
                borderColor: '#ef5350',
                borderColor0: '#26a69a'
            },
            xAxisIndex: 0,
            yAxisIndex: 0
        },
        {
            name: 'MA5',
            type: 'line',
            data: ma5Data,
            smooth: true,
            showSymbol: false,
            lineStyle: { width: 1, color: 'rgba(255, 193, 7, 0.6)' },
            xAxisIndex: 0,
            yAxisIndex: 0
        },
        {
            name: 'MA10',
            type: 'line',
            data: ma10Data,
            smooth: true,
            showSymbol: false,
            lineStyle: { width: 1, color: 'rgba(33, 150, 243, 0.6)' },
            xAxisIndex: 0,
            yAxisIndex: 0
        },
        {
            name: 'MA20',
            type: 'line',
            data: ma20Data,
            smooth: true,
            showSymbol: false,
            lineStyle: { width: 1, color: 'rgba(156, 39, 176, 0.6)' },
            xAxisIndex: 0,
            yAxisIndex: 0
        },
        {
            name: 'æˆäº¤é‡',
            type: 'bar',
            data: volumeData,
            xAxisIndex: 1,
            yAxisIndex: 1,
            itemStyle: { color: 'rgba(100, 150, 200, 0.5)' }
        }
    ];
    
    const foreignData = data.map(d => {
        const val = d['å¤–è³‡è²·è³£è¶…'];
        return (val !== undefined && val !== null && val !== 0) ? val / 1000 : null;
    });
    const trustData = data.map(d => {
        const val = d['æŠ•ä¿¡è²·è³£è¶…'];
        return (val !== undefined && val !== null && val !== 0) ? val / 1000 : null;
    });
    const dealerData = data.map(d => {
        const val = d['è‡ªç‡Ÿå•†è²·è³£è¶…'];
        return (val !== undefined && val !== null && val !== 0) ? val / 1000 : null;
    });
    
    const hasChipData = foreignData.some(v => v !== null) || trustData.some(v => v !== null) || dealerData.some(v => v !== null);
    if (!hasChipData) {
        console.warn('ç„¡ç±Œç¢¼è³‡æ–™ï¼Œè«‹åŸ·è¡Œ fetch_chip_data.py æ“·å–ç±Œç¢¼è³‡æ–™');
    }
    
    series.push({
        name: 'å¤–è³‡è²·è³£è¶…',
        type: 'line',
        data: foreignData,
        xAxisIndex: 2,
        yAxisIndex: 2,
        showSymbol: false,
        lineStyle: { width: 2, color: 'rgba(255, 99, 132, 0.8)' }
    });
    
    series.push({
        name: 'æŠ•ä¿¡è²·è³£è¶…',
        type: 'line',
        data: trustData,
        xAxisIndex: 2,
        yAxisIndex: 2,
        showSymbol: false,
        lineStyle: { width: 2, color: 'rgba(54, 162, 235, 0.8)' }
    });
    
    series.push({
        name: 'è‡ªç‡Ÿå•†è²·è³£è¶…',
        type: 'line',
        data: dealerData,
        xAxisIndex: 2,
        yAxisIndex: 2,
        showSymbol: false,
        lineStyle: { width: 2, color: 'rgba(75, 192, 192, 0.8)' }
    });
    
    const legendData = ['Kç·š', 'MA5', 'MA10', 'MA20', 'æˆäº¤é‡', 'å¤–è³‡è²·è³£è¶…', 'æŠ•ä¿¡è²·è³£è¶…', 'è‡ªç‡Ÿå•†è²·è³£è¶…'];
    
    results.forEach((result, idx) => {
        const buyPoints = [];
        const sellPoints = [];
        
        result.trades.forEach(trade => {
            const dateIdx = dates.indexOf(trade.æ—¥æœŸ);
            if (dateIdx !== -1) {
                if (trade.é¡å‹ === 'è²·å…¥') {
                    buyPoints.push({
                        value: [dateIdx, trade.åƒ¹æ ¼],
                        label: { show: true, formatter: String(trade.äº¤æ˜“ç·¨è™Ÿ || ''), position: 'top', color: '#fff', backgroundColor: '#f44336', padding: 3, borderRadius: 3, fontSize: 10 }
                    });
                } else if (trade.é¡å‹ === 'è³£å‡º') {
                    const buyTrade = result.trades.find(t => t.é¡å‹ === 'è²·å…¥' && trade.è²·å…¥è¨˜éŒ„ && trade.è²·å…¥è¨˜éŒ„.some(r => r.æ—¥æœŸ === t.æ—¥æœŸ));
                    sellPoints.push({
                        value: [dateIdx, trade.åƒ¹æ ¼],
                        label: { show: true, formatter: buyTrade && buyTrade.äº¤æ˜“ç·¨è™Ÿ ? String(buyTrade.äº¤æ˜“ç·¨è™Ÿ) : '', position: 'top', color: '#fff', backgroundColor: '#4caf50', padding: 3, borderRadius: 3, fontSize: 10 }
                    });
                }
            }
        });
        
        series.push({
            name: 'è²·å…¥',
            type: 'scatter',
            data: buyPoints,
            symbol: 'pin',
            symbolSize: 35,
            itemStyle: { color: '#f44336' },
            xAxisIndex: 0,
            yAxisIndex: 0,
            z: 10
        });
        
        series.push({
            name: 'è³£å‡º',
            type: 'scatter',
            data: sellPoints,
            symbol: 'pin',
            symbolSize: 35,
            itemStyle: { color: '#4caf50' },
            tooltip: {
                formatter: function(params) {
                    const dateIdx = params.data.value[0];
                    const trade = result.trades.find(t => t.é¡å‹ === 'è³£å‡º' && dates.indexOf(t.æ—¥æœŸ) === dateIdx);
                    let info = `æ—¥æœŸ: ${dates[dateIdx]}<br/>åƒ¹æ ¼: ${params.data.value[1]}`;
                    if (trade && trade.è³£å‡ºåŸå› ) {
                        info += `<br/>è³£å‡ºåŸå› : ${trade.è³£å‡ºåŸå› }`;
                    }
                    return info;
                }
            },
            xAxisIndex: 0,
            yAxisIndex: 0,
            z: 10
        });
        
        legendData.push('è²·å…¥', 'è³£å‡º');
        
        const equityData = dates.map(date => {
            const equity = result.equity_curve.find(e => e.æ—¥æœŸ === date);
            return equity ? equity.å·²å¯¦ç¾æç›Š : null;
        });
        
        series.push({
            name: 'å·²å¯¦ç¾æç›Š',
            type: 'line',
            data: equityData,
            smooth: true,
            showSymbol: false,
            lineStyle: { width: 2, color: '#ff9800' },
            xAxisIndex: 3,
            yAxisIndex: 3
        });
        
        legendData.push('å·²å¯¦ç¾æç›Š');
    });
    
    chart.setOption({
        title: { text: 'å›æ¸¬Kç·šåœ–', left: 'center' },
        tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
        legend: { data: legendData, top: 30, type: 'scroll' },
        grid: [
            { left: '8%', right: '3%', top: '10%', height: '28%' },
            { left: '8%', right: '3%', top: '42%', height: '10%' },
            { left: '8%', right: '3%', top: '56%', height: '12%' },
            { left: '8%', right: '3%', top: '72%', height: '15%' }
        ],
        xAxis: [
            { type: 'category', data: dates, gridIndex: 0 },
            { type: 'category', data: dates, gridIndex: 1 },
            { type: 'category', data: dates, gridIndex: 2 },
            { type: 'category', data: dates, gridIndex: 3 }
        ],
        yAxis: [
            { scale: true, gridIndex: 0, name: 'åƒ¹æ ¼' },
            { scale: true, gridIndex: 1, name: 'æˆäº¤é‡' },
            { scale: true, gridIndex: 2, name: 'ä¸‰å¤§æ³•äºº(å¼µ)' },
            { scale: true, gridIndex: 3, name: 'å·²å¯¦ç¾æç›Š' }
        ],
        dataZoom: [
            { type: 'inside', xAxisIndex: [0, 1, 2, 3], start: 80, end: 100 },
            { show: true, xAxisIndex: [0, 1, 2, 3], type: 'slider', bottom: '1%', start: 80, end: 100 }
        ],
        series: series
    });
}

function saveBuyStrategy() {
    if (buyStrategies.length === 0) {
        alert('è«‹å…ˆè¨­å®šè²·é€²ç­–ç•¥');
        return;
    }
    const name = prompt('è«‹è¼¸å…¥è²·é€²ç­–ç•¥åç¨±:');
    if (!name) return;
    let saved = JSON.parse(localStorage.getItem('savedBuyStrategies') || '[]');
    saved.push({ name, strategies: buyStrategies.map(s => ({ indicators: s.indicators })) });
    localStorage.setItem('savedBuyStrategies', JSON.stringify(saved));
    loadSavedBuyStrategiesList();
    alert('è²·é€²ç­–ç•¥å·²å„²å­˜!');
}

function saveSellStrategy() {
    if (sellStrategies.length === 0) {
        alert('è«‹å…ˆè¨­å®šè³£å‡ºç­–ç•¥');
        return;
    }
    const name = prompt('è«‹è¼¸å…¥è³£å‡ºç­–ç•¥åç¨±:');
    if (!name) return;
    let saved = JSON.parse(localStorage.getItem('savedSellStrategies') || '[]');
    saved.push({ name, strategies: sellStrategies.map(s => ({ indicators: s.indicators })) });
    localStorage.setItem('savedSellStrategies', JSON.stringify(saved));
    loadSavedSellStrategiesList();
    alert('è³£å‡ºç­–ç•¥å·²å„²å­˜!');
}

function loadSavedBuyStrategiesList() {
    const select = document.getElementById('savedBuyStrategies');
    const saved = JSON.parse(localStorage.getItem('savedBuyStrategies') || '[]');
    select.innerHTML = '<option value="">-- è¼‰å…¥ --</option>';
    saved.forEach((strategy, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.text = strategy.name;
        select.appendChild(option);
    });
}

function loadSavedSellStrategiesList() {
    const select = document.getElementById('savedSellStrategies');
    const saved = JSON.parse(localStorage.getItem('savedSellStrategies') || '[]');
    select.innerHTML = '<option value="">-- è¼‰å…¥ --</option>';
    saved.forEach((strategy, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.text = strategy.name;
        select.appendChild(option);
    });
}

function loadSavedBuyStrategy() {
    const select = document.getElementById('savedBuyStrategies');
    const idx = select.value;
    if (idx === '') return;
    const saved = JSON.parse(localStorage.getItem('savedBuyStrategies') || '[]');
    const strategy = saved[idx];
    if (!strategy) return;
    buyStrategies = [];
    buyStrategyCounter = 0;
    strategy.strategies.forEach(s => {
        const id = ++buyStrategyCounter;
        buyStrategies.push({ id, indicators: s.indicators, confirmed: false });
    });
    renderBuyStrategies();
    alert('è²·é€²ç­–ç•¥å·²è¼‰å…¥!');
}

function loadSavedSellStrategy() {
    const select = document.getElementById('savedSellStrategies');
    const idx = select.value;
    if (idx === '') return;
    const saved = JSON.parse(localStorage.getItem('savedSellStrategies') || '[]');
    const strategy = saved[idx];
    if (!strategy) return;
    sellStrategies = [];
    sellStrategyCounter = 0;
    strategy.strategies.forEach(s => {
        const id = ++sellStrategyCounter;
        sellStrategies.push({ id, indicators: s.indicators, confirmed: false });
    });
    renderSellStrategies();
    alert('è³£å‡ºç­–ç•¥å·²è¼‰å…¥!');
}

function deleteBuyStrategy() {
    const select = document.getElementById('savedBuyStrategies');
    const idx = select.value;
    if (idx === '') {
        alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„ç­–ç•¥');
        return;
    }
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²·é€²ç­–ç•¥?')) return;
    let saved = JSON.parse(localStorage.getItem('savedBuyStrategies') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('savedBuyStrategies', JSON.stringify(saved));
    loadSavedBuyStrategiesList();
    alert('è²·é€²ç­–ç•¥å·²åˆªé™¤!');
}

function deleteSellStrategy() {
    const select = document.getElementById('savedSellStrategies');
    const idx = select.value;
    if (idx === '') {
        alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„ç­–ç•¥');
        return;
    }
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³£å‡ºç­–ç•¥?')) return;
    let saved = JSON.parse(localStorage.getItem('savedSellStrategies') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('savedSellStrategies', JSON.stringify(saved));
    loadSavedSellStrategiesList();
    alert('è³£å‡ºç­–ç•¥å·²åˆªé™¤!');
}

let sectorsData = {};

function loadLevel2() {
    const level1 = document.getElementById('level1Select').value;
    const level2Select = document.getElementById('level2Select');
    level2Select.innerHTML = '<option value="">å…¨éƒ¨</option>';
    
    if (level1 !== 'å…¨éƒ¨' && sectorsData[level1]) {
        sectorsData[level1].forEach(level2 => {
            const option = document.createElement('option');
            option.value = level2;
            option.text = level2;
            level2Select.appendChild(option);
        });
    }
    
    loadStocksBySector();
}

function loadStocksBySector() {
    const level1 = document.getElementById('level1Select').value;
    const level2 = document.getElementById('level2Select').value;
    
    let url = `/api/stocks?level1=${encodeURIComponent(level1)}`;
    if (level2) url += `&level2=${encodeURIComponent(level2)}`;
    
    fetch(url)
        .then(res => res.json())
        .then(stocks => {
            const select = document.getElementById('stockSelect');
            select.innerHTML = '';
            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock.code;
                option.text = `${stock.code} ${stock.name}`;
                select.appendChild(option);
            });
        })
        .catch(err => {
            console.error('è¼‰å…¥è‚¡ç¥¨åˆ—è¡¨å¤±æ•—:', err);
        });
}

document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/sectors')
        .then(res => res.json())
        .then(sectors => {
            sectorsData = sectors;
            const select = document.getElementById('level1Select');
            Object.keys(sectors).sort().forEach(level1 => {
                const option = document.createElement('option');
                option.value = level1;
                option.text = level1;
                select.appendChild(option);
            });
            loadStocksBySector();
        });
    
    loadSavedBuyStrategiesList();
    loadSavedSellStrategiesList();
    addBuyStrategy();
    addSellStrategy();
});
</script>
{% endblock %}
