{% extends "layout.html" %}

{% block title %}å¤šæª”å›æ¸¬{% endblock %}

{% block extra_style %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
{% endblock %}

{% block content %}
<h1>å¤šæª”è‚¡ç¥¨å›æ¸¬ç³»çµ±</h1>

<div style="margin: 20px 0;">
    <label>æ—ç¾¤: </label>
    <select id="level1Select" onchange="loadLevel2()" style="padding: 5px;">
        <option value="å…¨éƒ¨">å…¨éƒ¨</option>
    </select>
    <select id="level2Select" onchange="loadStocks()" style="padding: 5px; margin-left: 10px;">
        <option value="">å…¨éƒ¨</option>
    </select>
    <button onclick="selectAll()" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">å…¨é¸</button>
    <button onclick="clearAll()" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px;">æ¸…é™¤</button>
    <label style="margin-left: 20px;">æ¯æª”è³‡é‡‘: </label>
    <input type="number" id="initialCapital" value="300000" style="width: 120px;">
</div>

<div id="stockList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: white; border-radius: 4px; margin: 20px 0;"></div>

<div style="display: flex; gap: 30px; margin: 20px 0;">
    <div style="flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3>è²·é€²ç­–ç•¥ (ä»»ä¸€ç­–ç•¥é”æ¨™å³è²·é€²)</h3>
            <div style="display: flex; gap: 5px;">
                <button onclick="saveBuyStrategy()" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ’¾</button>
                <select id="savedBuyStrategies" onchange="loadSavedBuyStrategy()" style="padding: 5px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- è¼‰å…¥ --</option>
                </select>
                <button onclick="deleteBuyStrategy()" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
            </div>
        </div>
        <button onclick="addBuyStrategy()" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">â• æ–°å¢è²·é€²ç­–ç•¥</button>
        <div id="buyStrategies"></div>
    </div>
    
    <div style="flex: 1;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h3>è³£å‡ºç­–ç•¥ (ä»»ä¸€ç­–ç•¥é”æ¨™å³è³£å‡º)</h3>
            <div style="display: flex; gap: 5px;">
                <button onclick="saveSellStrategy()" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ’¾</button>
                <select id="savedSellStrategies" onchange="loadSavedSellStrategy()" style="padding: 5px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- è¼‰å…¥ --</option>
                </select>
                <button onclick="deleteSellStrategy()" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ğŸ—‘ï¸</button>
            </div>
        </div>
        <button onclick="addSellStrategy()" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 10px;">â• æ–°å¢è³£å‡ºç­–ç•¥</button>
        <div id="sellStrategies"></div>
    </div>
</div>

<div style="margin: 20px 0;">
    <button onclick="runMultiBacktest()" style="padding: 10px 30px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">åŸ·è¡Œå¤šæª”å›æ¸¬</button>
</div>

<div id="results" style="display: none;"></div>

<script>
let sectorsData = {};
let stockList = [];
let selectedStocks = [];
let buyStrategies = [];
let sellStrategies = [];
let buyStrategyCounter = 0;
let sellStrategyCounter = 0;

const indicatorConfigs = {
    ma_crossover: { name: 'MAå‡ç·šäº¤å‰', category: 'æŠ€è¡“é¡', params: { short_window: 5, long_window: 20 } },
    rsi: { name: 'RSIæŒ‡æ¨™', category: 'æŠ€è¡“é¡', params: { period: 14, buy_threshold: 30, sell_threshold: 70 } },
    high_volume: { name: 'çˆ†é‡', category: 'æŠ€è¡“é¡', params: { volume_multiplier: 2.0 } },
    ma_slope_up: { name: 'MAå‘ä¸Š', category: 'æŠ€è¡“é¡', params: { window: 20, threshold: 10, hold_days: 3 } },
    ma_slope_down: { name: 'MAå‘ä¸‹', category: 'æŠ€è¡“é¡', params: { window: 20, threshold: -10, hold_days: 3 } },
    take_profit: { name: 'åœåˆ©', category: 'é¢¨æ§é¡', params: { profit_pct: 10 } },
    stop_loss: { name: 'åœæ', category: 'é¢¨æ§é¡', params: { loss_pct: -5 } },
    foreign_consecutive_buy: { name: 'å¤–è³‡é€£çºŒè²·è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    trust_consecutive_buy: { name: 'æŠ•ä¿¡é€£çºŒè²·è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    dealer_consecutive_buy: { name: 'è‡ªç‡Ÿå•†é€£çºŒè²·è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    foreign_consecutive_sell: { name: 'å¤–è³‡é€£çºŒè³£è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    trust_consecutive_sell: { name: 'æŠ•ä¿¡é€£çºŒè³£è¶…', category: 'ç±Œç¢¼é¡', params: { days: 3 } },
    foreign_holding_high: { name: 'å¤–è³‡æŒè‚¡æ¯”é«˜', category: 'ç±Œç¢¼é¡', params: { threshold: 30 } },
    foreign_holding_low: { name: 'å¤–è³‡æŒè‚¡æ¯”ä½', category: 'ç±Œç¢¼é¡', params: { threshold: 10 } },
    trust_volume_ratio: { name: 'æŠ•ä¿¡è²·å…¥å äº¤æ˜“é‡æ¯”', category: 'ç±Œç¢¼é¡', params: { days: 5, volume_ratio: 10 } }
};

// è¼‰å…¥æ—ç¾¤è³‡æ–™
fetch('/api/sectors')
    .then(res => res.json())
    .then(sectors => {
        sectorsData = sectors;
        const select = document.getElementById('level1Select');
        Object.keys(sectors).sort().forEach(level1 => {
            const option = document.createElement('option');
            option.value = level1;
            option.text = level1;
            select.appendChild(option);
        });
        loadStocks();
    });

function loadLevel2() {
    const level1 = document.getElementById('level1Select').value;
    const level2Select = document.getElementById('level2Select');
    level2Select.innerHTML = '<option value="">å…¨éƒ¨</option>';
    
    if (level1 !== 'å…¨éƒ¨' && sectorsData[level1]) {
        sectorsData[level1].forEach(level2 => {
            const option = document.createElement('option');
            option.value = level2;
            option.text = level2;
            level2Select.appendChild(option);
        });
    }
    loadStocks();
}

function loadStocks() {
    // è¼‰å…¥æ‰€æœ‰æ—ç¾¤çš„è‚¡ç¥¨è³‡æ–™
    const promises = [];
    
    Object.keys(sectorsData).forEach(level1 => {
        sectorsData[level1].forEach(level2 => {
            promises.push(
                fetch(`/api/stocks?level1=${encodeURIComponent(level1)}&level2=${encodeURIComponent(level2)}`)
                    .then(res => res.json())
                    .then(stocks => ({ level1, level2, stocks }))
            );
        });
    });
    
    Promise.all(promises).then(results => {
        stockList = results.filter(item => item.stocks.length > 0);
        renderStockList();
    });
}

function renderStockList() {
    const container = document.getElementById('stockList');
    
    // æŒ‰level1åˆ†çµ„
    const level1Groups = {};
    stockList.forEach(item => {
        if (!level1Groups[item.level1]) {
            level1Groups[item.level1] = [];
        }
        level1Groups[item.level1].push(item);
    });
    
    // è¨ˆç®—ç¸½è‚¡ç¥¨æ•¸
    const totalAllStocks = stockList.reduce((sum, item) => sum + item.stocks.length, 0);
    
    let html = '';
    // æ–°å¢å…¨éƒ¨é¸é …
    html += `<div style="margin: 5px 0; border: 2px solid #2196F3; border-radius: 4px;">`;
    html += `<div style="background: #e3f2fd; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleAllSection()">`;
    html += `<span><input type="checkbox" id="selectAll" onchange="toggleAllStocks()" onclick="event.stopPropagation()"> <strong>å…¨éƒ¨ (${totalAllStocks}æ”¯)</strong></span>`;
    html += `<span id="arrow_all">â–¼</span>`;
    html += `</div>`;
    html += `<div id="content_all" style="display: none; padding: 5px;">`;
    
    Object.keys(level1Groups).sort().forEach((level1, index) => {
        const level1Id = `L1_${index}_${level1.replace(/[\s\W]/g, '_')}`;
        const totalStocks = level1Groups[level1].reduce((sum, item) => sum + item.stocks.length, 0);
        
        html += `<div style="margin: 5px 0; border: 1px solid #ccc; border-radius: 4px;">`;
        html += `<div style="background: #f0f0f0; padding: 8px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleLevel1('${level1Id}')">`;
        html += `<span><input type="checkbox" id="level1_${level1Id}" onchange="toggleLevel1Group('${level1Id}')" onclick="event.stopPropagation()"> <strong>${level1} (${totalStocks}æ”¯)</strong></span>`;
        html += `<span id="arrow_${level1Id}">â–¼</span>`;
        html += `</div>`;
        html += `<div id="content_${level1Id}" style="display: none; padding: 5px;">`;
        
        level1Groups[level1].forEach((item, idx) => {
            const level2Id = `${level1Id}_L2_${idx}_${item.level2.replace(/[\s\W]/g, '_')}`;
            html += `<div style="margin: 3px 0; padding-left: 15px;">`;
            html += `<div style="background: #f8f8f8; padding: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleLevel2('${level2Id}')">`;
            html += `<span><input type="checkbox" id="level2_${level2Id}" onchange="toggleLevel2Group('${level2Id}')" onclick="event.stopPropagation()"> <strong>${item.level2} (${item.stocks.length}æ”¯)</strong></span>`;
            html += `<span id="arrow2_${level2Id}">â–¼</span>`;
            html += `</div>`;
            html += `<div id="stocks_${level2Id}" style="display: none; padding-left: 20px;">`;
            html += item.stocks.map(stock => `
                <label style="display: inline-block; width: 160px; margin: 1px;">
                    <input type="checkbox" value="${stock.code}" class="level1_${level1Id} level2_${level2Id}" onchange="updateSelection()"> 
                    ${stock.code} ${stock.name}
                </label>
            `).join('');
            html += `</div></div>`;
        });
        
        html += `</div></div>`;
    });
    
    html += `</div></div>`; // é—œé–‰å…¨éƒ¨å€å¡Š
    
    container.innerHTML = html;
}

function updateSelection() {
    selectedStocks = Array.from(document.querySelectorAll('#stockList input[type="checkbox"]:checked'))
        .map(cb => cb.value)
        .filter(value => value && !value.startsWith('group_'));
}

function toggleLevel1(level1Id) {
    const content = document.getElementById(`content_${level1Id}`);
    const arrow = document.getElementById(`arrow_${level1Id}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = 'â–²';
    } else {
        content.style.display = 'none';
        arrow.textContent = 'â–¼';
    }
}

function toggleLevel1Group(level1Id) {
    const level1Checkbox = document.getElementById(`level1_${level1Id}`);
    const stockCheckboxes = document.querySelectorAll(`.level1_${level1Id}`);
    
    stockCheckboxes.forEach(cb => cb.checked = level1Checkbox.checked);
    
    // æ›´æ–°level2çš„checkbox
    document.querySelectorAll(`[id^="level2_${level1Id}_"]`).forEach(cb => {
        cb.checked = level1Checkbox.checked;
    });
    
    updateSelection();
}

function toggleLevel2(level2Id) {
    const content = document.getElementById(`stocks_${level2Id}`);
    const arrow = document.getElementById(`arrow2_${level2Id}`);
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = 'â–²';
    } else {
        content.style.display = 'none';
        arrow.textContent = 'â–¼';
    }
}

function toggleLevel2Group(level2Id) {
    const level2Checkbox = document.getElementById(`level2_${level2Id}`);
    const stockCheckboxes = document.querySelectorAll(`.level2_${level2Id}`);
    
    stockCheckboxes.forEach(cb => cb.checked = level2Checkbox.checked);
    updateSelection();
}

function toggleAllSection() {
    const content = document.getElementById('content_all');
    const arrow = document.getElementById('arrow_all');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = 'â–²';
    } else {
        content.style.display = 'none';
        arrow.textContent = 'â–¼';
    }
}

function toggleAllStocks() {
    const allCheckbox = document.getElementById('selectAll');
    document.querySelectorAll('#stockList input[type="checkbox"]').forEach(cb => {
        if (cb.id !== 'selectAll') {
            cb.checked = allCheckbox.checked;
        }
    });
    updateSelection();
}

function selectAll() {
    document.getElementById('selectAll').checked = true;
    toggleAllStocks();
}

function clearAll() {
    document.getElementById('selectAll').checked = false;
    toggleAllStocks();
}

function addBuyStrategy() {
    const id = ++buyStrategyCounter;
    buyStrategies.push({ id, indicators: [], confirmed: false });
    renderBuyStrategies();
}

function addSellStrategy() {
    const id = ++sellStrategyCounter;
    sellStrategies.push({ id, indicators: [], confirmed: false });
    renderSellStrategies();
}

function confirmBuyStrategy(id) {
    const strategy = buyStrategies.find(s => s.id === id);
    if (strategy && strategy.indicators.length > 0) {
        strategy.confirmed = true;
        renderBuyStrategies();
    } else {
        alert('ç­–ç•¥è‡³å°‘éœ€è¦ä¸€å€‹æŒ‡æ¨™');
    }
}

function confirmSellStrategy(id) {
    const strategy = sellStrategies.find(s => s.id === id);
    if (strategy && strategy.indicators.length > 0) {
        strategy.confirmed = true;
        renderSellStrategies();
    } else {
        alert('ç­–ç•¥è‡³å°‘éœ€è¦ä¸€å€‹æŒ‡æ¨™');
    }
}

function editBuyStrategy(id) {
    const strategy = buyStrategies.find(s => s.id === id);
    if (strategy) {
        strategy.confirmed = false;
        renderBuyStrategies();
    }
}

function editSellStrategy(id) {
    const strategy = sellStrategies.find(s => s.id === id);
    if (strategy) {
        strategy.confirmed = false;
        renderSellStrategies();
    }
}

function removeBuyStrategy(id) {
    buyStrategies = buyStrategies.filter(s => s.id !== id);
    renderBuyStrategies();
}

function removeSellStrategy(id) {
    sellStrategies = sellStrategies.filter(s => s.id !== id);
    renderSellStrategies();
}

function addIndicatorToBuy(strategyId) {
    const strategy = buyStrategies.find(s => s.id === strategyId);
    if (strategy) {
        strategy.indicators.push({ type: 'ma_crossover', params: {...indicatorConfigs.ma_crossover.params} });
        renderBuyStrategies();
    }
}

function addIndicatorToSell(strategyId) {
    const strategy = sellStrategies.find(s => s.id === strategyId);
    if (strategy) {
        strategy.indicators.push({ type: 'ma_crossover', params: {...indicatorConfigs.ma_crossover.params} });
        renderSellStrategies();
    }
}

function removeIndicatorFromBuy(strategyId, indicatorIdx) {
    const strategy = buyStrategies.find(s => s.id === strategyId);
    if (strategy) {
        strategy.indicators.splice(indicatorIdx, 1);
        renderBuyStrategies();
    }
}

function removeIndicatorFromSell(strategyId, indicatorIdx) {
    const strategy = sellStrategies.find(s => s.id === strategyId);
    if (strategy) {
        strategy.indicators.splice(indicatorIdx, 1);
        renderSellStrategies();
    }
}

function changeIndicatorType(strategyId, indicatorIdx, isBuy) {
    const strategies = isBuy ? buyStrategies : sellStrategies;
    const strategy = strategies.find(s => s.id === strategyId);
    if (strategy && strategy.indicators[indicatorIdx]) {
        const select = event.target;
        const newType = select.value;
        strategy.indicators[indicatorIdx] = { 
            type: newType, 
            params: {...indicatorConfigs[newType].params} 
        };
        isBuy ? renderBuyStrategies() : renderSellStrategies();
    }
}

function updateParam(strategyId, indicatorIdx, paramName, isBuy) {
    const strategies = isBuy ? buyStrategies : sellStrategies;
    const strategy = strategies.find(s => s.id === strategyId);
    if (strategy && strategy.indicators[indicatorIdx]) {
        strategy.indicators[indicatorIdx].params[paramName] = parseFloat(event.target.value);
    }
}

function renderBuyStrategies() {
    const container = document.getElementById('buyStrategies');
    container.innerHTML = buyStrategies.map(strategy => {
        if (strategy.confirmed) {
            return `
                <div style="border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin: 10px 0; background: #e8f5e9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>âœ“ ç­–ç•¥ ${strategy.id} (${strategy.indicators.length} å€‹æŒ‡æ¨™)</strong>
                        <div>
                            <button onclick="editBuyStrategy(${strategy.id})" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">ç·¨è¼¯</button>
                            <button onclick="removeBuyStrategy(${strategy.id})" style="background: #f44336; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `;
        }
        return `
            <div style="border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin: 10px 0; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>ç­–ç•¥ ${strategy.id} (æ‰€æœ‰æŒ‡æ¨™éƒ½é”æ¨™æ‰è²·é€²)</strong>
                    <button onclick="removeBuyStrategy(${strategy.id})" style="background: #f44336; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">åˆªé™¤ç­–ç•¥</button>
                </div>
                ${strategy.indicators.map((ind, idx) => `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 8px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <select onchange="changeIndicatorType(${strategy.id}, ${idx}, true)">
                                ${Object.entries(indicatorConfigs).reduce((acc, [key, config]) => {
                                    if (!acc.categories.includes(config.category)) {
                                        acc.categories.push(config.category);
                                        acc.html += `<optgroup label="${config.category}">`;
                                    }
                                    acc.html += `<option value="${key}" ${ind.type === key ? 'selected' : ''}>${config.name}</option>`;
                                    return acc;
                                }, { categories: [], html: '' }).html + '</optgroup>'}
                            </select>
                            <button onclick="removeIndicatorFromBuy(${strategy.id}, ${idx})" style="background: #f44336; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">âœ•</button>
                        </div>
                        <div style="margin-top: 8px;">
                            ${Object.keys(ind.params).map(param => `
                                <label style="margin-right: 10px; font-size: 13px;">
                                    ${param}: <input type="number" step="1" value="${ind.params[param]}" 
                                        onchange="updateParam(${strategy.id}, ${idx}, '${param}', true)" 
                                        style="width: 70px;">
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="addIndicatorToBuy(${strategy.id})" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">â• æ–°å¢æŒ‡æ¨™</button>
                    <button onclick="confirmBuyStrategy(${strategy.id})" style="background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">âœ“ å®Œæˆ</button>
                </div>
            </div>
        `;
    }).join('');
}

function renderSellStrategies() {
    const container = document.getElementById('sellStrategies');
    container.innerHTML = sellStrategies.map(strategy => {
        if (strategy.confirmed) {
            return `
                <div style="border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin: 10px 0; background: #e8f5e9;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>âœ“ ç­–ç•¥ ${strategy.id} (${strategy.indicators.length} å€‹æŒ‡æ¨™)</strong>
                        <div>
                            <button onclick="editSellStrategy(${strategy.id})" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">ç·¨è¼¯</button>
                            <button onclick="removeSellStrategy(${strategy.id})" style="background: #f44336; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">åˆªé™¤</button>
                        </div>
                    </div>
                </div>
            `;
        }
        return `
            <div style="border: 2px solid #2196F3; border-radius: 8px; padding: 15px; margin: 10px 0; background: #f8f9fa;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong>ç­–ç•¥ ${strategy.id} (æ‰€æœ‰æŒ‡æ¨™éƒ½é”æ¨™æ‰è³£å‡º)</strong>
                    <button onclick="removeSellStrategy(${strategy.id})" style="background: #f44336; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">åˆªé™¤ç­–ç•¥</button>
                </div>
                ${strategy.indicators.map((ind, idx) => `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 8px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <select onchange="changeIndicatorType(${strategy.id}, ${idx}, false)">
                                ${Object.entries(indicatorConfigs).reduce((acc, [key, config]) => {
                                    if (!acc.categories.includes(config.category)) {
                                        acc.categories.push(config.category);
                                        acc.html += `<optgroup label="${config.category}">`;
                                    }
                                    acc.html += `<option value="${key}" ${ind.type === key ? 'selected' : ''}>${config.name}</option>`;
                                    return acc;
                                }, { categories: [], html: '' }).html + '</optgroup>'}
                            </select>
                            <button onclick="removeIndicatorFromSell(${strategy.id}, ${idx})" style="background: #f44336; color: white; border: none; padding: 4px 10px; border-radius: 4px; cursor: pointer;">âœ•</button>
                        </div>
                        <div style="margin-top: 8px;">
                            ${Object.keys(ind.params).map(param => `
                                <label style="margin-right: 10px; font-size: 13px;">
                                    ${param}: <input type="number" step="1" value="${ind.params[param]}" 
                                        onchange="updateParam(${strategy.id}, ${idx}, '${param}', false)" 
                                        style="width: 70px;">
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button onclick="addIndicatorToSell(${strategy.id})" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">â• æ–°å¢æŒ‡æ¨™</button>
                    <button onclick="confirmSellStrategy(${strategy.id})" style="background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">âœ“ å®Œæˆ</button>
                </div>
            </div>
        `;
    }).join('');
}

// ç­–ç•¥å„²å­˜å’Œè¼‰å…¥åŠŸèƒ½
function saveBuyStrategy() {
    if (buyStrategies.length === 0) {
        alert('è«‹å…ˆè¨­å®šè²·é€²ç­–ç•¥');
        return;
    }
    const name = prompt('è«‹è¼¸å…¥è²·é€²ç­–ç•¥åç¨±:');
    if (!name) return;
    let saved = JSON.parse(localStorage.getItem('savedBuyStrategies') || '[]');
    saved.push({ name, strategies: buyStrategies.map(s => ({ indicators: s.indicators })) });
    localStorage.setItem('savedBuyStrategies', JSON.stringify(saved));
    loadSavedBuyStrategiesList();
}

function saveSellStrategy() {
    if (sellStrategies.length === 0) {
        alert('è«‹å…ˆè¨­å®šè³£å‡ºç­–ç•¥');
        return;
    }
    const name = prompt('è«‹è¼¸å…¥è³£å‡ºç­–ç•¥åç¨±:');
    if (!name) return;
    let saved = JSON.parse(localStorage.getItem('savedSellStrategies') || '[]');
    saved.push({ name, strategies: sellStrategies.map(s => ({ indicators: s.indicators })) });
    localStorage.setItem('savedSellStrategies', JSON.stringify(saved));
    loadSavedSellStrategiesList();
}

function loadSavedBuyStrategiesList() {
    const select = document.getElementById('savedBuyStrategies');
    const saved = JSON.parse(localStorage.getItem('savedBuyStrategies') || '[]');
    select.innerHTML = '<option value="">-- è¼‰å…¥ --</option>';
    saved.forEach((strategy, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.text = strategy.name;
        select.appendChild(option);
    });
}

function loadSavedSellStrategiesList() {
    const select = document.getElementById('savedSellStrategies');
    const saved = JSON.parse(localStorage.getItem('savedSellStrategies') || '[]');
    select.innerHTML = '<option value="">-- è¼‰å…¥ --</option>';
    saved.forEach((strategy, idx) => {
        const option = document.createElement('option');
        option.value = idx;
        option.text = strategy.name;
        select.appendChild(option);
    });
}

function loadSavedBuyStrategy() {
    const select = document.getElementById('savedBuyStrategies');
    const idx = select.value;
    if (idx === '') return;
    const saved = JSON.parse(localStorage.getItem('savedBuyStrategies') || '[]');
    const strategy = saved[idx];
    if (!strategy) return;
    buyStrategies = [];
    buyStrategyCounter = 0;
    strategy.strategies.forEach(s => {
        const id = ++buyStrategyCounter;
        buyStrategies.push({ id, indicators: s.indicators, confirmed: false });
    });
    renderBuyStrategies();
}

function loadSavedSellStrategy() {
    const select = document.getElementById('savedSellStrategies');
    const idx = select.value;
    if (idx === '') return;
    const saved = JSON.parse(localStorage.getItem('savedSellStrategies') || '[]');
    const strategy = saved[idx];
    if (!strategy) return;
    sellStrategies = [];
    sellStrategyCounter = 0;
    strategy.strategies.forEach(s => {
        const id = ++sellStrategyCounter;
        sellStrategies.push({ id, indicators: s.indicators, confirmed: false });
    });
    renderSellStrategies();
}

function deleteBuyStrategy() {
    const select = document.getElementById('savedBuyStrategies');
    const idx = select.value;
    if (idx === '') {
        alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„ç­–ç•¥');
        return;
    }
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è²·é€²ç­–ç•¥?')) return;
    let saved = JSON.parse(localStorage.getItem('savedBuyStrategies') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('savedBuyStrategies', JSON.stringify(saved));
    loadSavedBuyStrategiesList();
    alert('è²·é€²ç­–ç•¥å·²åˆªé™¤!');
}

function deleteSellStrategy() {
    const select = document.getElementById('savedSellStrategies');
    const idx = select.value;
    if (idx === '') {
        alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„ç­–ç•¥');
        return;
    }
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³£å‡ºç­–ç•¥?')) return;
    let saved = JSON.parse(localStorage.getItem('savedSellStrategies') || '[]');
    saved.splice(idx, 1);
    localStorage.setItem('savedSellStrategies', JSON.stringify(saved));
    loadSavedSellStrategiesList();
    alert('è³£å‡ºç­–ç•¥å·²åˆªé™¤!');
}

// åˆå§‹åŒ–ç­–ç•¥åˆ—è¡¨
document.addEventListener('DOMContentLoaded', function() {
    loadSavedBuyStrategiesList();
    loadSavedSellStrategiesList();
});

function runMultiBacktest() {
    if (selectedStocks.length === 0) {
        alert('è«‹é¸æ“‡è‡³å°‘ä¸€æ”¯è‚¡ç¥¨');
        return;
    }
    if (buyStrategies.length === 0 || sellStrategies.length === 0) {
        alert('è«‹è¨­å®šè²·é€²å’Œè³£å‡ºç­–ç•¥');
        return;
    }
    
    const hasEmptyBuy = buyStrategies.some(s => s.indicators.length === 0);
    const hasEmptySell = sellStrategies.some(s => s.indicators.length === 0);
    if (hasEmptyBuy || hasEmptySell) {
        alert('æ¯å€‹ç­–ç•¥è‡³å°‘éœ€è¦ä¸€å€‹æŒ‡æ¨™');
        return;
    }
    
    const hasUnconfirmedBuy = buyStrategies.some(s => !s.confirmed);
    const hasUnconfirmedSell = sellStrategies.some(s => !s.confirmed);
    if (hasUnconfirmedBuy || hasUnconfirmedSell) {
        alert('è«‹å…ˆå®Œæˆæ‰€æœ‰ç­–ç•¥çš„è¨­å®š');
        return;
    }
    
    const initialCapital = document.getElementById('initialCapital').value;
    const results = [];
    let completed = 0;
    
    document.getElementById('results').style.display = 'block';
    document.getElementById('results').innerHTML = '<h2>å›æ¸¬é€²è¡Œä¸­...</h2>';
    
    selectedStocks.forEach(code => {
        const buyData = buyStrategies.map(s => ({ indicators: s.indicators }));
        const sellData = sellStrategies.map(s => ({ indicators: s.indicators }));
        
        fetch(`/api/backtest/${code}?buy_strategies=${encodeURIComponent(JSON.stringify(buyData))}&sell_strategies=${encodeURIComponent(JSON.stringify(sellData))}&initial_capital=${initialCapital}`)
            .then(res => res.json())
            .then(result => {
                if (!result.error) {
                    const stockInfo = stockList.reduce((acc, item) => {
                        const found = item.stocks.find(s => s.code === code);
                        return found ? found : acc;
                    }, null);
                    results.push({
                        code,
                        name: stockInfo ? stockInfo.name : code,
                        ...result
                    });
                }
                completed++;
                if (completed === selectedStocks.length) {
                    displayResults(results);
                }
            });
    });
}

function displayResults(results) {
    results.sort((a, b) => b.return_rate - a.return_rate);
    
    // è¨ˆç®—æ•´é«”çµ±è¨ˆ
    const totalStocks = results.length;
    const tradedStocks = results.filter(r => r.total_trades > 0);
    const tradedCount = tradedStocks.length;
    const noTradeCount = totalStocks - tradedCount;
    
    const winStocks = tradedStocks.filter(r => r.return_rate > 0).length;
    const loseStocks = tradedStocks.filter(r => r.return_rate < 0).length;
    const breakEvenStocks = tradedStocks.filter(r => r.return_rate === 0).length;
    const winRate = tradedCount > 0 ? (winStocks / tradedCount * 100) : 0;
    
    const avgReturn = tradedCount > 0 ? tradedStocks.reduce((sum, r) => sum + r.return_rate, 0) / tradedCount : 0;
    const totalProfit = results.reduce((sum, r) => sum + r.profit, 0);
    const totalTrades = results.reduce((sum, r) => sum + r.total_trades, 0);
    const avgTrades = tradedCount > 0 ? totalTrades / tradedCount : 0;
    
    const avgWinRate = tradedCount > 0 ? tradedStocks.reduce((sum, r) => sum + r.win_rate, 0) / tradedCount : 0;
    const maxReturn = Math.max(...results.map(r => r.return_rate));
    const minReturn = Math.min(...results.map(r => r.return_rate));
    const maxProfit = Math.max(...results.map(r => r.profit));
    const minProfit = Math.min(...results.map(r => r.profit));
    
    let html = '<h2>å¤šæª”å›æ¸¬çµæœ</h2>';
    
    // æ•´é«”çµ±è¨ˆè¡¨æ ¼
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">';
    html += '<h3 style="margin-top: 0;">æ•´é«”çµ±è¨ˆ</h3>';
    html += '<table style="width: 100%; border-collapse: collapse;">';
    html += '<tbody>';
    
    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; background: #fff; width: 25%;"><strong>æ¸¬è©¦è‚¡ç¥¨æ•¸</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff;">${totalStocks} æ”¯</td>`;
    html += `<td style="padding: 8px; border: 1px solid #ddd; background: #fff; width: 25%;"><strong>æœ‰äº¤æ˜“è‚¡ç¥¨</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff;">${tradedCount} æ”¯</td></tr>`;
    
    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>ç„¡äº¤æ˜“è‚¡ç¥¨</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: #999;">${noTradeCount} æ”¯ (${(noTradeCount/totalStocks*100).toFixed(2)}%)</td>`;
    html += `<td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>ç¸½äº¤æ˜“æ¬¡æ•¸</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff;">${totalTrades} æ¬¡</td></tr>`;
    
    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>ç²åˆ©è‚¡ç¥¨</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: #f44336; font-weight: bold;">${winStocks} æ”¯ (${winRate.toFixed(2)}%)</td>`;
    html += `<td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>å¹³å‡äº¤æ˜“æ¬¡æ•¸</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff;">${avgTrades.toFixed(2)} æ¬¡/è‚¡</td></tr>`;
    
    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>è™§æè‚¡ç¥¨</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: #4caf50; font-weight: bold;">${loseStocks} æ”¯ (${tradedCount > 0 ? (loseStocks/tradedCount*100).toFixed(2) : 0}%)</td>`;
    html += `<td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>å¹³å‡å€‹è‚¡å‹ç‡</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff;">${avgWinRate.toFixed(2)}%</td></tr>`;
    
    const totalProfitColor = totalProfit >= 0 ? '#f44336' : '#4caf50';
    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>ç¸½ç²åˆ©</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: ${totalProfitColor}; font-weight: bold; font-size: 16px;">${totalProfit.toLocaleString()}</td>`;
    const avgReturnColor = avgReturn >= 0 ? '#f44336' : '#4caf50';
    html += `<td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>å¹³å‡å ±é…¬ç‡</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: ${avgReturnColor}; font-weight: bold; font-size: 16px;">${avgReturn.toFixed(2)}%</td></tr>`;
    
    const maxReturnColor = maxReturn >= 0 ? '#f44336' : '#4caf50';
    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>æœ€é«˜å ±é…¬ç‡</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: ${maxReturnColor}; font-weight: bold;">${maxReturn.toFixed(2)}%</td>`;
    const maxProfitColor = maxProfit >= 0 ? '#f44336' : '#4caf50';
    html += `<td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>æœ€é«˜ç²åˆ©</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: ${maxProfitColor}; font-weight: bold;">${maxProfit.toLocaleString()}</td></tr>`;
    
    const minReturnColor = minReturn >= 0 ? '#f44336' : '#4caf50';
    html += `<tr><td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>æœ€ä½å ±é…¬ç‡</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: ${minReturnColor}; font-weight: bold;">${minReturn.toFixed(2)}%</td>`;
    const minProfitColor = minProfit >= 0 ? '#f44336' : '#4caf50';
    html += `<td style="padding: 8px; border: 1px solid #ddd; background: #fff;"><strong>æœ€ä½ç²åˆ©</strong></td><td style="padding: 8px; border: 1px solid #ddd; background: #fff; color: ${minProfitColor}; font-weight: bold;">${minProfit.toLocaleString()}</td></tr>`;
    
    html += '</tbody></table></div>';
    
    // å€‹è‚¡æ˜ç´°è¡¨æ ¼
    html += '<h3>å€‹è‚¡æ˜ç´°</h3>';
    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
    html += '<thead><tr style="background: #f5f5f5;"><th style="padding: 10px; border: 1px solid #ddd;">æ’å</th><th style="padding: 10px; border: 1px solid #ddd;">è‚¡ç¥¨</th><th style="padding: 10px; border: 1px solid #ddd;">å ±é…¬ç‡</th><th style="padding: 10px; border: 1px solid #ddd;">ç²åˆ©</th><th style="padding: 10px; border: 1px solid #ddd;">äº¤æ˜“æ¬¡æ•¸</th><th style="padding: 10px; border: 1px solid #ddd;">å‹ç‡</th></tr></thead>';
    html += '<tbody>';
    
    results.forEach((result, idx) => {
        const profitColor = result.return_rate >= 0 ? '#f44336' : '#4caf50';
        html += `<tr>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${idx + 1}</td>
            <td style="padding: 10px; border: 1px solid #ddd; cursor: pointer; color: #2196F3; text-decoration: underline;" onclick="showStockDetail('${result.code}', '${result.name}')">${result.code} ${result.name}</td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: ${profitColor}; font-weight: bold;">${result.return_rate.toFixed(2)}%</td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: right; color: ${profitColor};">${result.profit.toLocaleString()}</td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${result.total_trades}</td>
            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${result.win_rate.toFixed(2)}%</td>
        </tr>`;
    });
    
    html += '</tbody></table>';
    
    document.getElementById('results').innerHTML = html;
}

function showStockDetail(code, name) {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
    modal.innerHTML = `<div style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 1400px; max-height: 90%; overflow-y: auto; position: relative;">
        <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 16px; z-index: 10;">âœ•</button>
        <h2>${code} ${name} - å›æ¸¬è©³æƒ…</h2>
        <div id="modalContent" style="text-align: center; padding: 40px;">è¼‰å…¥ä¸­...</div>
    </div>`;
    document.body.appendChild(modal);
    
    const initialCapital = document.getElementById('initialCapital').value;
    const buyData = buyStrategies.map(s => ({ indicators: s.indicators }));
    const sellData = sellStrategies.map(s => ({ indicators: s.indicators }));
    
    Promise.all([
        fetch(`/api/backtest/${code}?buy_strategies=${encodeURIComponent(JSON.stringify(buyData))}&sell_strategies=${encodeURIComponent(JSON.stringify(sellData))}&initial_capital=${initialCapital}`).then(res => res.json()),
        fetch(`/api/data/${code}`).then(res => res.json())
    ])
    .then(([backtestData, chartData]) => {
        if (backtestData.error) {
            document.getElementById('modalContent').innerHTML = `<p style="color: red;">${backtestData.error}</p>`;
            return;
        }
        
        let html = `<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <h3>ç¸¾æ•ˆæ‘˜è¦</h3>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: left;">
                <div><strong>å ±é…¬ç‡:</strong> <span style="color: ${(backtestData.return_rate || 0) >= 0 ? '#f44336' : '#4caf50'}; font-weight: bold;">${(backtestData.return_rate || 0).toFixed(2)}%</span></div>
                <div><strong>ç²åˆ©:</strong> <span style="color: ${(backtestData.profit || 0) >= 0 ? '#f44336' : '#4caf50'};">${(backtestData.profit || 0).toLocaleString()}</span></div>
                <div><strong>äº¤æ˜“æ¬¡æ•¸:</strong> ${backtestData.total_trades || 0}</div>
                <div><strong>å‹ç‡:</strong> ${(backtestData.win_rate || 0).toFixed(2)}%</div>
                <div><strong>æœ€çµ‚åƒ¹å€¼:</strong> ${(backtestData.final_value || 0).toLocaleString()}</div>
                <div><strong>æœ€å¤§å›æ’¤:</strong> ${(backtestData.max_drawdown || 0).toFixed(2)}%</div>
            </div>
        </div>`;
        
        html += '<div id="stockChart" style="width: 100%; height: 600px; margin: 20px 0;"></div>';
        
        if (backtestData.trades && backtestData.trades.length > 0) {
            const sellTrades = backtestData.trades.filter(t => t.é¡å‹ === 'è³£å‡º');
            html += '<h3>äº¤æ˜“æ˜ç´°</h3><table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px;"><thead><tr style="background: #f5f5f5;"><th style="padding: 8px; border: 1px solid #ddd;">#</th><th style="padding: 8px; border: 1px solid #ddd;">è²·å…¥æ—¥æœŸ</th><th style="padding: 8px; border: 1px solid #ddd;">è²·å…¥åƒ¹</th><th style="padding: 8px; border: 1px solid #ddd;">è³£å‡ºæ—¥æœŸ</th><th style="padding: 8px; border: 1px solid #ddd;">è³£å‡ºåƒ¹</th><th style="padding: 8px; border: 1px solid #ddd;">æ•¸é‡</th><th style="padding: 8px; border: 1px solid #ddd;">ç²åˆ©</th><th style="padding: 8px; border: 1px solid #ddd;">å ±é…¬ç‡</th></tr></thead><tbody>';
            sellTrades.forEach(trade => {
                const buyRecords = trade.è²·å…¥è¨˜éŒ„ || [];
                const buyDates = buyRecords.map(r => r.æ—¥æœŸ).join(', ');
                const avgBuyPrice = buyRecords.length > 0 ? (buyRecords.reduce((sum, r) => sum + r.åƒ¹æ ¼ * r.æ•¸é‡, 0) / trade.æ•¸é‡).toFixed(2) : 0;
                const profitColor = (trade.ç²åˆ© || 0) >= 0 ? '#f44336' : '#4caf50';
                const buyTrade = backtestData.trades.find(t => t.é¡å‹ === 'è²·å…¥' && buyRecords.some(r => r.æ—¥æœŸ === t.æ—¥æœŸ));
                const tradeNum = buyTrade && buyTrade.äº¤æ˜“ç·¨è™Ÿ ? buyTrade.äº¤æ˜“ç·¨è™Ÿ : '-';
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${tradeNum}</td><td style="padding: 8px; border: 1px solid #ddd;">${buyDates}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${avgBuyPrice}</td><td style="padding: 8px; border: 1px solid #ddd;">${trade.æ—¥æœŸ || ''}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(trade.åƒ¹æ ¼ || 0).toFixed(2)}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right;">${(trade.æ•¸é‡ || 0).toLocaleString()}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: ${profitColor}; font-weight: bold;">${(trade.ç²åˆ© || 0).toLocaleString()}</td><td style="padding: 8px; border: 1px solid #ddd; text-align: right; color: ${profitColor}; font-weight: bold;">${(trade.å ±é…¬ç‡ || 0).toFixed(2)}%</td></tr>`;
            });
            html += '</tbody></table>';
        }
        
        document.getElementById('modalContent').innerHTML = html;
        
        // ä½¿ç”¨ ECharts ç¹ªè£½åœ–è¡¨
        const chart = echarts.init(document.getElementById('stockChart'));
        const dates = chartData.map(d => d.æ—¥æœŸ);
        const klineData = chartData.map(d => [d.é–‹ç›¤åƒ¹, d.æ”¶ç›¤åƒ¹, d.æœ€ä½åƒ¹, d.æœ€é«˜åƒ¹]);
        
        const series = [{
            name: 'Kç·š',
            type: 'candlestick',
            data: klineData,
            itemStyle: { color: '#ef5350', color0: '#26a69a', borderColor: '#ef5350', borderColor0: '#26a69a' }
        }];
        
        const buyPoints = [];
        const sellPoints = [];
        backtestData.trades.forEach(trade => {
            const dateIdx = dates.indexOf(trade.æ—¥æœŸ);
            if (dateIdx !== -1) {
                if (trade.é¡å‹ === 'è²·å…¥') {
                    buyPoints.push({ value: [dateIdx, trade.åƒ¹æ ¼], label: { show: true, formatter: String(trade.äº¤æ˜“ç·¨è™Ÿ || ''), position: 'top', color: '#fff', backgroundColor: '#f44336', padding: 3, borderRadius: 3, fontSize: 10 } });
                } else if (trade.é¡å‹ === 'è³£å‡º') {
                    const buyTrade = backtestData.trades.find(t => t.é¡å‹ === 'è²·å…¥' && trade.è²·å…¥è¨˜éŒ„ && trade.è²·å…¥è¨˜éŒ„.some(r => r.æ—¥æœŸ === t.æ—¥æœŸ));
                    sellPoints.push({ value: [dateIdx, trade.åƒ¹æ ¼], label: { show: true, formatter: buyTrade && buyTrade.äº¤æ˜“ç·¨è™Ÿ ? String(buyTrade.äº¤æ˜“ç·¨è™Ÿ) : '', position: 'top', color: '#fff', backgroundColor: '#4caf50', padding: 3, borderRadius: 3, fontSize: 10 } });
                }
            }
        });
        
        series.push({ name: 'è²·å…¥', type: 'scatter', data: buyPoints, symbol: 'pin', symbolSize: 35, itemStyle: { color: '#f44336' }, z: 10 });
        series.push({ name: 'è³£å‡º', type: 'scatter', data: sellPoints, symbol: 'pin', symbolSize: 35, itemStyle: { color: '#4caf50' }, z: 10 });
        
        chart.setOption({
            title: { text: `${code} ${name} å›æ¸¬çµæœ`, left: 'center' },
            tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
            legend: { data: ['Kç·š', 'è²·å…¥', 'è³£å‡º'], top: 30 },
            grid: { left: '8%', right: '3%', top: '15%', bottom: '15%' },
            xAxis: { type: 'category', data: dates },
            yAxis: { scale: true },
            dataZoom: [{ type: 'inside', start: 0, end: 100 }, { show: true, type: 'slider', bottom: '5%', start: 0, end: 100 }],
            series: series
        });
    })
    .catch(err => {
        document.getElementById('modalContent').innerHTML = `<p style="color: red;">è¼‰å…¥å¤±æ•—: ${err.message}</p>`;
    });
}
</script>
{% endblock %}